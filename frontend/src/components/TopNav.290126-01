"use client";

import { useRouter, usePathname } from "next/navigation";
import { useSession } from "@/context/SessionContext";

const I18N = {
  EN: {
    dashboard: "Dashboard",
    newRepair: "New Repair",
    logout: "Logout",
  },
  FR: {
    dashboard: "Tableau de bord",
    newRepair: "Nouvelle rÃ©paration",
    logout: "DÃ©connexion",
  },
};

export default function TopNav() {
  const router = useRouter();
  const pathname = usePathname();
  const { session, setSession, loading } = useSession();

  /* ðŸ” Do NOT early-return before hooks finish */
  const hideNav =
    pathname === "/auth/login" ||
    pathname === "/" ||
    loading ||
    !session;

  if (hideNav) {
    return null;
  }

  const currentLang = session.language === "FR" ? "FR" : "EN";
  const toggleLabel = currentLang === "EN" ? "FR" : "EN";
  const t = I18N[currentLang];

  const toggleLanguage = () => {
    setSession({
      ...session,
      language: toggleLabel,
    });
  };

  const handleLogout = () => {
    setSession(null);
    router.push("/auth/login");
  };

  return (
    <div style={barStyle}>
      {/* LEFT */}
      <div>
        <div style={{ fontWeight: "bold" }}>Touch of Tech Repairs</div>
        <div style={{ fontSize: 14, opacity: 0.8 }}>
          {session.role === "admin"
            ? "Administrator"
            : session.showroom?.name}
        </div>
      </div>

      {/* CENTER */}
      <div style={{ display: "flex", gap: 10 }}>
        <NavButton label={t.dashboard} />
        <PrimaryButton
          label={t.newRepair}
          onClick={() => router.push("/repairs/new")}
        />
      </div>

      {/* RIGHT */}
      <div style={{ display: "flex", gap: 14, alignItems: "center" }}>
        <button onClick={toggleLanguage} style={langBtnStyle}>
          {toggleLabel}
        </button>

        <div style={{ fontSize: 13 }}>
          {session.full_name} ({session.role})
        </div>

        <button onClick={handleLogout} style={logoutStyle}>
          {t.logout}
        </button>
      </div>
    </div>
  );
}

/* UI helpers */
function NavButton({ label }: { label: string }) {
  return <button style={navBtnStyle}>{label}</button>;
}

function PrimaryButton({
  label,
  onClick,
}: {
  label: string;
  onClick: () => void;
}) {
  return (
    <button
      onClick={onClick}
      style={{
        background: "linear-gradient(90deg,#6366f1,#06b6d4)",
        border: "none",
        color: "white",
        borderRadius: 6,
        padding: "6px 14px",
        fontWeight: "bold",
        cursor: "pointer",
      }}
    >
      {label}
    </button>
  );
}

/* Styles */
const barStyle = {
  height: 55,
  background: "linear-gradient(90deg, #0f172a, #1e293b)",
  color: "white",
  padding: "0 20px",
  display: "flex",
  justifyContent: "space-between",
  alignItems: "center",
  position: "fixed" as const,
  top: 0,
  left: 0,
  width: "100%",
  zIndex: 1000,
};

const navBtnStyle = {
  background: "transparent",
  color: "white",
  border: "none",
};

const logoutStyle = {
  padding: "6px 12px",
  borderRadius: 6,
  border: "none",
  cursor: "pointer",
  fontWeight: "bold",
  background: "#dc2626",
  color: "white",
};

const langBtnStyle = {
  padding: "4px 10px",
  borderRadius: 6,
  border: "1px solid white",
  background: "transparent",
  color: "white",
  fontWeight: "bold",
  cursor: "pointer",
};