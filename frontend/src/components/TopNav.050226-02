"use client";

import { useRouter, usePathname } from "next/navigation";
import { useSession } from "@/context/SessionContext";
import { Settings, Smartphone, Building2 } from "lucide-react"; // Icons for Gear and Devices

const I18N = {
  EN: {
    dashboard: "Dashboard",
    newRepair: "New Repair",
    parameters: "Parameters",
    logout: "Logout",
  },
  FR: {
    dashboard: "Tableau de bord",
    newRepair: "Nouvelle rÃ©paration",
    parameters: "ParamÃ¨tres",
    logout: "DÃ©connexion",
  },
};

export default function TopNav() {
  const router = useRouter();
  const pathname = usePathname();
  const { session, setSession, loading } = useSession();

  /* ðŸ” Do NOT early-return before hooks finish */
  const hideNav =
    pathname === "/auth/login" ||
    pathname === "/" ||
    loading ||
    !session;

  if (hideNav) {
    return null;
  }

  const currentLang = session.language === "FR" ? "FR" : "EN";
  const toggleLabel = currentLang === "EN" ? "FR" : "EN";
  const t = I18N[currentLang];

  const toggleLanguage = () => {
    setSession({
      ...session,
      language: toggleLabel,
    });
  };

  const handleLogout = () => {
    setSession(null);
    router.push("/auth/login");
  };

  const canManage = session.role === "admin" || session.role === "manager";

  return (
    <div style={barStyle}>
      {/* LEFT - Logo and Name */}
      <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
        {/* 1. Showroom Logo or Building Icon */}
        {session.showroom?.logo_url ? (
          <img 
            src={session.showroom.logo_url} 
            alt="Logo" 
            style={{ height: 35, width: 35, borderRadius: 6, objectFit: "contain", background: "white" }} 
          />
        ) : (
          <div style={{ height: 35, width: 35, borderRadius: 6, background: "#334155", display: "flex", alignItems: "center", justifyCenter: "center" }}>
            <Building2 size={20} style={{ margin: "auto" }} />
          </div>
        )}
        
        <div>
          <div style={{ fontWeight: "bold" }}>Touch of Tech Repairs</div>
          <div style={{ fontSize: 14, opacity: 0.8 }}>
            {session.role === "admin"
              ? "Administrator"
              : session.showroom?.name}
          </div>
        </div>
      </div>

      {/* CENTER - Navigation */}
      <div style={{ display: "flex", gap: 15, alignItems: "center" }}>
        <NavButton 
          label={t.dashboard} 
          onClick={() => router.push("/dashboard")} 
        />

        {/* 2. Parameters Gear Icon (For Admin/Manager) */}
        {canManage && (
          <IconButton
            icon={<Settings size={20} />}
            title={t.parameters}
            onClick={() => router.push("/admin/parameters")}
          />
        )}

        {/* 3. Devices Smartphone Icon (For Admin) */}
        {session.role === "admin" && (
          <IconButton
            icon={<Smartphone size={20} />}
            title="Devices"
            onClick={() => router.push("/admin/devices")}
          />
        )}

        <PrimaryButton
          label={t.newRepair}
          onClick={() => router.push("/repairs/new")}
        />
      </div>

      {/* RIGHT - Auth and Language */}
      <div style={{ display: "flex", gap: 14, alignItems: "center" }}>
        <button onClick={toggleLanguage} style={langBtnStyle}>
          {toggleLabel}
        </button>

        <div style={{ fontSize: 13 }}>
          {session.full_name} ({session.role})
        </div>

        <button onClick={handleLogout} style={logoutStyle}>
          {t.logout}
        </button>
      </div>
    </div>
  );
}

/* UI helpers */
function NavButton({ label, onClick }: { label: string; onClick?: () => void }) {
  return (
    <button style={navBtnStyle} onClick={onClick}>
      {label}
    </button>
  );
}

// Helper for the Gear and Phone icons
function IconButton({ icon, onClick, title }: { icon: React.ReactNode; onClick: () => void; title: string }) {
  return (
    <button 
      onClick={onClick} 
      title={title}
      style={{ ...navBtnStyle, display: "flex", alignItems: "center", opacity: 0.8 }}
      onMouseOver={(e) => (e.currentTarget.style.opacity = "1")}
      onMouseOut={(e) => (e.currentTarget.style.opacity = "0.8")}
    >
      {icon}
    </button>
  );
}

function PrimaryButton({ label, onClick }: { label: string; onClick: () => void }) {
  return (
    <button
      onClick={onClick}
      style={{
        background: "linear-gradient(90deg,#6366f1,#06b6d4)",
        border: "none",
        color: "white",
        borderRadius: 6,
        padding: "6px 14px",
        fontWeight: "bold",
        cursor: "pointer",
      }}
    >
      {label}
    </button>
  );
}

/* Styles (unchanged) */
const barStyle = {
  height: 55,
  background: "linear-gradient(90deg, #0f172a, #1e293b)",
  color: "white",
  padding: "0 20px",
  display: "flex",
  justifyContent: "space-between",
  alignItems: "center",
  position: "fixed" as const,
  top: 0,
  left: 0,
  width: "100%",
  zIndex: 1000,
};

const navBtnStyle = {
  background: "transparent",
  color: "white",
  border: "none",
  cursor: "pointer",
};

const logoutStyle = {
  padding: "6px 12px",
  borderRadius: 6,
  border: "none",
  cursor: "pointer",
  fontWeight: "bold",
  background: "#dc2626",
  color: "white",
};

const langBtnStyle = {
  padding: "4px 10px",
  borderRadius: 6,
  border: "1px solid white",
  background: "transparent",
  color: "white",
  fontWeight: "bold",
  cursor: "pointer",
};